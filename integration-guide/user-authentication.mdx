---
title:
description:
---

To integrate the user authentication process using the ethers library and the provided Gateway API code, follow these steps:

1. Install the required dependencies:

   ```bash
   npm install ethers axios
   ```

2. Import the necessary libraries:

   ```javascript
   const ethers = require("ethers");
   const axios = require("axios");
   ```

3. Implement the user authentication process:

   ```javascript
   async function authenticateUser(wallet) {
     try {
       // Make a request to the Gateway API to create a user nonce
       const data = JSON.stringify({
         query: `mutation($wallet: String!) {
           createUserNonce(input: {
             signingKey: $wallet,
             encryptionKey: "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0NCk1JSUNJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBZzhBTUlJQ0NnS0NBZ0VBdjZadVA3dXNrc2JDM1crdG1VSHENCjRISVVaV0pGdE0xOGZUWFliQXN5SEh0UVpWY1A0Z3NWRE90c3NybDRsYUZPelJvQ1NaQUhUVHNuVnhtTnFxaisNClNMemxXeXBCQ0pkT2NGWENYeVM2Zkh1UDdwR3lJUUljTDlhVndsUWtkR0crYjdGcWRhNi9PMlk5VVVsL3VFTXgNCjZQbSs3ZFBraFgyVU1BYWlqVW9lWVVDMnpqeUJBN2pyL1dLSG53WjZPSDBQazVnNHVIT0x4eHJzYlJFMDBQR2kNCnhRc3FCWmZ5OU9XbU5Sc3EremJuOGxSQTRhYUdqeDdKTzZ0WVRraG0yR2pWR2M2RUllbXlYN0V3L08zbmFLMEINCmFQakErb3dOK05oUURLcXRpOTZzRmVmVUw2OEI5Z0VHOXU5WC9CNW05cTNpNXkxUS9uakcvcDkvQ2o0aUkyREYNCkFvSzJsUDdQSzBZcG81WXZNKzZLRitEVUZCSGQ1VmQ3bFpWM2hpZWllRmJteEV1MnhLWTgxTzJpM0prM3hJc2INCkN5TGpmU0hIdUpHSllCV3MvVUExdkErVlZ6VWlxYmN1NWt1RmhyeUxYTktUdFo2RDhmU3hpYnFacVRVeEtRZVINClVJaTZ2WFpoR1FBS3RHc2lJZUdzYVRqQ1NjVmI4RlpZZXBRRGk5dituVytHMXBMU1FkK3d4SU5aMEZlNHJJSUoNClhTRE9OcTA3Yks0VThYUWxibXdMV1FWSWJQRVlwTThiQUVuVnB6c0NHZ2JoeE9sZi9HcW1BQmlWVlVvWjdvQnANClZYYVd0OGl5QUVyVnhMZWZockRFZm9Gby9qeFYxcmExYWFiSHQ1WDhwSVZMYlQ1Qi85d2ZzMHVpTk9OWGtQcjENCm14SVkwK0tNa25WWUM2WVdyNHg3U0VNQ0F3RUFBUT09DQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0NCg==",
             did: "did:gatewayid:joao",
             deviceToken: "joao_device"
           })
         }`,
         variables: { wallet: wallet },
       });

       const config = {
         method: "post",
         maxBodyLength: Infinity,
         url: "https://sandbox.protocol.mygateway.xyz/graphql",
         headers: {
           "x-api-key": "local",
           "Content-Type": "application/json",
           Authorization: "Bearer {{ _.token }}",
         },
         data: data,
       };

       // Send the request to the Gateway API
       const response = await axios.request(config);

       // Extract the nonce from the response
       const nonce = response.data.data.createUserNonce;

       // Request the user to sign the nonce using their wallet
       const provider = new ethers.providers.Web3Provider(window.ethereum);
       await provider.send("eth_requestAccounts", []);
       const signer = provider.getSigner();
       const signature = await signer.signMessage(nonce);

       // Send the signature back to the Gateway API for verification
       const verificationData = JSON.stringify({
         query: `mutation($signature: String!) {
           verifyUserSignature(input: {
             signature: $signature
           })
         }`,
         variables: { signature: signature },
       });

       const verificationConfig = {
         method: "post",
         maxBodyLength: Infinity,
         url: "https://sandbox.protocol.mygateway.xyz/graphql",
         headers: {
           "x-api-key": "local",
           "Content-Type": "application/json",
           Authorization: "Bearer {{ _.token }}",
         },
         data: verificationData,
       };

       const verificationResponse = await axios.request(verificationConfig);

       // Check the verification response
       if (verificationResponse.data.data.verifyUserSignature) {
         console.log("User authentication successful");
         // Proceed with further actions or redirect the user
       } else {
         console.log("User authentication failed");
         // Handle authentication failure
       }
     } catch (error) {
       console.log("Error during user authentication:", error);
       // Handle errors
     }
   }
   ```

   This function takes the user's wallet address as input and performs the following steps:

   - Sends a request to the Gateway API to create a user nonce.
   - Extracts the nonce from the response.
   - Requests the user to sign the nonce using their wallet (assuming MetaMask is being used).
   - Sends the signature back to the Gateway API for verification.
   - Checks the verification response and handles the authentication result accordingly.

4. Call the `authenticateUser` function with the user's wallet address:

   ```javascript
   const userWalletAddress = "0x1234567890123456789012345678901234567890";
   authenticateUser(userWalletAddress);
   ```

   Replace `'0x1234567890123456789012345678901234567890'` with the actual user's wallet address.

Note: Make sure to handle errors and provide appropriate user feedback throughout the authentication process.

This code demonstrates how to integrate the user authentication process using the ethers library and the provided Gateway API code. It assumes that the user has MetaMask installed and connected to their wallet. The code sends requests to the Gateway API to create a user nonce, requests the user to sign the nonce, and then verifies the signature to authenticate the user.
